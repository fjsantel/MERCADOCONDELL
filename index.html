
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercado Condell</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://api.fontshare.com/v2/css?f[]=author@400,700&display=swap" rel="stylesheet">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <!-- Breakpoint Markers (hidden by default) -->
    <div id="bpMarkers" class="bp-markers-container">
        <div class="bp-marker desktop">Desktop (>1200px)</div>
        <div class="bp-marker tablet">Tablet (‚â§1200px)</div>
        <div class="bp-marker mobile">Mobile (‚â§768px)</div>
        <div class="bp-marker small-mobile">Small Mobile (‚â§480px)</div>
        <div class="bp-marker extra-small">Extra Small (‚â§380px)</div>
    </div>
    
    <!-- Toggle Button (hidden by default) -->
    <button id="bpToggle" class="bp-toggle hidden" onclick="toggleBpMarkers()">BP</button>
    
    <div class="main-container">
        <!-- Header Section -->
        <header class="header">
            <div class="header-left">
                <img src="assets/Logo-02.svg" alt="Mercado Condell" class="logo-svg">
            </div>
            <div class="header-center">
                <!-- Centro del header -->
            </div>
            <div class="header-right">
                <div class="menu-container">
                    <button class="menu-button" onclick="toggleMenu()">MEN√ö</button>
                    <div class="menu-dropdown" id="menuDropdown">
                        <a href="#inicio" class="menu-item">Inicio</a>
                        <a href="#tiendas" class="menu-item">Tiendas</a>
                        <a href="#actividades" class="menu-item">Actividades</a>
                        <a href="#historia" class="menu-item">Historia</a>
                        <a href="#como-llegar" class="menu-item">C√≥mo llegar</a>
                        <a href="#contacto" class="menu-item">Contacto</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Map Section -->
        <section class="map-section">
            <div class="map-container">
                <img src="assets/mapa v1.svg" alt="Mapa Mercado Condell" class="map-image">
            </div>
            <!-- Map circles for small mobile -->
            <div class="map-circle circle-1">1
                <div class="tooltip" id="tooltip-1">Cargando...</div>
            </div>
            <div class="map-circle circle-2">2
                <div class="tooltip" id="tooltip-2">Cargando...</div>
            </div>
            <div class="map-circle circle-3">3
                <div class="tooltip" id="tooltip-3">Cargando...</div>
            </div>
            <div class="map-circle circle-4">4
                <div class="tooltip" id="tooltip-4">Cargando...</div>
            </div>
            <div class="map-circle circle-5">5
                <div class="tooltip" id="tooltip-5">Cargando...</div>
            </div>
            <div class="map-circle circle-6">6
                <div class="tooltip" id="tooltip-6">Cargando...</div>
            </div>
            <div class="map-circle circle-7">7
                <div class="tooltip" id="tooltip-7">Cargando...</div>
            </div>
            <div class="map-circle circle-8">8
                <div class="tooltip" id="tooltip-8">Cargando...</div>
            </div>
            <div class="map-circle circle-9">9
                <div class="tooltip" id="tooltip-9">Cargando...</div>
            </div>
            <div class="map-circle circle-10">10
                <div class="tooltip" id="tooltip-10">Cargando...</div>
            </div>
            <div class="map-circle circle-11">11
                <div class="tooltip" id="tooltip-11">Cargando...</div>
            </div>
            <div class="map-circle circle-12">12
                <div class="tooltip" id="tooltip-12">Cargando...</div>
            </div>
            <div class="map-circle circle-13">13
                <div class="tooltip" id="tooltip-13">Cargando...</div>
            </div>
            <div class="map-circle circle-14">14
                <div class="tooltip" id="tooltip-14">Cargando...</div>
            </div>
            <div class="map-circle circle-15">15
                <div class="tooltip" id="tooltip-15">Cargando...</div>
            </div>
            <div class="map-circle circle-16">16
                <div class="tooltip" id="tooltip-16">Cargando...</div>
            </div>
            <div class="map-circle circle-17">17
                <div class="tooltip" id="tooltip-17">Cargando...</div>
            </div>
            <div class="map-circle circle-18">18
                <div class="tooltip" id="tooltip-18">Cargando...</div>
            </div>
            <div class="map-circle circle-19">19
                <div class="tooltip" id="tooltip-19">Cargando...</div>
            </div>
            <div class="map-circle circle-20">20
                <div class="tooltip" id="tooltip-20">Cargando...</div>
            </div>
        </section>

        <!-- Store Information Section -->
        <section class="store-info">
            <div class="store-info-container">
                <div class="store-info-left">
                    <div class="store-number-circle" id="storeNumberCircle">1</div>
                    <div class="category-filter-container">
                        <button id="categoryFilterBtn" class="category-filter-button" onclick="toggleCategoryFilter()">
                            FILTRAR CATEGOR√çAS
                        </button>
                        <div id="categoryFilterDropdown" class="category-filter-dropdown">
                            <select id="categorySelect" onchange="filterByCategory()">
                                <option value="">Todas las categor√≠as</option>
                                <option value="alimentos">Alimentos</option>
                                <option value="ropa">Ropa</option>
                                <option value="musica">M√∫sica</option>
                                <option value="decoracion">Decoraci√≥n</option>
                                <option value="cultura">Cultura</option>
                                <option value="artesanias">Artesan√≠as</option>
                                <option value="tecnologia">Tecnolog√≠a</option>
                                <option value="belleza">Belleza</option>
                                <option value="juguetes">Juguetes</option>
                                <option value="hogar">Hogar</option>
                                <option value="servicios">Servicios</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="store-info-center">
                    <div class="store-description">
                        <p id="storeDescription">Selecciona un n√∫mero en el mapa para ver la informaci√≥n de la tienda.</p>
                    </div>
                    <button id="verMasBtn" class="ver-mas-button" onclick="openStoreDetailPopup()" style="display: none;">VER M√ÅS</button>
                </div>
                <div class="store-info-right">
                    <div class="store-info-right-top">
                        <h2 class="store-name" id="storeName">MERCADO CONDELL</h2>
                    </div>
                    <div class="store-info-right-bottom">
                        <div class="social-icons">
                            <div class="social-icon"></div>
                            <div class="social-icon"></div>
                            <div class="social-icon"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile layout: Circle + Title in same line -->
                <div class="mobile-header">
                    <div class="store-number-circle mobile-circle" id="storeNumberCircleMobile">1</div>
                    <h2 class="store-name mobile-title" id="storeNameMobile">MERCADO CONDELL</h2>
                </div>
                
                <!-- Mobile description and social icons -->
                <div class="mobile-content">
                    <div class="store-description mobile-description">
                        <p id="storeDescriptionMobile">Selecciona un n√∫mero en el mapa para ver la informaci√≥n de la tienda.</p>
                    </div>
                    <button id="verMasBtnMobile" class="ver-mas-button mobile" onclick="openStoreDetailPopup()" style="display: none;">VER M√ÅS</button>
                    <div class="category-filter-container mobile-category-filter">
                        <button id="categoryFilterBtnMobile" class="category-filter-button mobile" onclick="toggleCategoryFilter()">
                            FILTRAR CATEGOR√çAS
                        </button>
                        <div id="categoryFilterDropdownMobile" class="category-filter-dropdown mobile">
                            <select id="categorySelectMobile" onchange="filterByCategoryMobile()">
                                <option value="">Todas las categor√≠as</option>
                                <option value="alimentos">Alimentos</option>
                                <option value="ropa">Ropa</option>
                                <option value="musica">M√∫sica</option>
                                <option value="decoracion">Decoraci√≥n</option>
                                <option value="cultura">Cultura</option>
                                <option value="artesanias">Artesan√≠as</option>
                                <option value="tecnologia">Tecnolog√≠a</option>
                                <option value="belleza">Belleza</option>
                                <option value="juguetes">Juguetes</option>
                                <option value="hogar">Hogar</option>
                                <option value="servicios">Servicios</option>
                            </select>
                        </div>
                    </div>
                    <div class="social-icons mobile-social">
                        <div class="social-icon"></div>
                        <div class="social-icon"></div>
                        <div class="social-icon"></div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Category Filter Popup Modal -->
    <div class="category-popup-overlay" id="categoryPopup">
        <div class="category-popup">
            <div class="category-popup-header">
                <div>
                    <h2 class="category-popup-title" id="popupCategoryName">Categor√≠a</h2>
                    <p class="category-popup-subtitle" id="popupStoreCount">0 tiendas encontradas</p>
                </div>
                <button class="category-popup-close" onclick="closeCategoryPopup()">‚úï</button>
            </div>
            <div class="category-popup-content" id="popupStoreList">
                <!-- Store cards will be inserted here dynamically -->
            </div>
        </div>
    </div>

    <!-- Store Detail Popup Modal -->
    <div class="store-detail-overlay" id="storeDetailPopup">
        <div class="store-detail-popup">
            <div class="store-detail-header">
                <div class="store-detail-header-info">
                    <div class="store-detail-number" id="detailStoreNumber">1</div>
                    <h2 class="store-detail-title" id="detailStoreName">Nombre de la Tienda</h2>
                </div>
                <button class="store-detail-close" onclick="closeStoreDetailPopup()">‚úï</button>
            </div>
            <div class="store-detail-content">
                <!-- Photo Slider -->
                <div class="photo-slider">
                    <div class="slider-container" id="sliderContainer">
                        <div class="slider-image">FOTO 1</div>
                        <div class="slider-image">FOTO 2</div>
                        <div class="slider-image">FOTO 3</div>
                    </div>
                    <button class="slider-button prev" onclick="previousSlide()">‚Äπ</button>
                    <button class="slider-button next" onclick="nextSlide()">‚Ä∫</button>
                    <div class="slider-dots" id="sliderDots">
                        <div class="slider-dot active" onclick="goToSlide(0)"></div>
                        <div class="slider-dot" onclick="goToSlide(1)"></div>
                        <div class="slider-dot" onclick="goToSlide(2)"></div>
                    </div>
                </div>

                <!-- Store Information -->
                <div class="store-detail-info">
                    <div class="store-detail-section">
                        <h3 class="store-detail-section-title">üìù Descripci√≥n</h3>
                        <p class="store-detail-description" id="detailStoreDescription">
                            Descripci√≥n de la tienda...
                        </p>
                    </div>

                    <div class="store-detail-section" id="detailLinksSection">
                        <h3 class="store-detail-section-title">üîó Enlaces y Contacto</h3>
                        <div class="store-detail-links" id="detailStoreLinks">
                            <!-- Links will be inserted here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleMenu() {
            const dropdown = document.getElementById('menuDropdown');
            const button = document.querySelector('.menu-button');
            
            dropdown.classList.toggle('show');
            button.classList.toggle('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menuContainer = document.querySelector('.menu-container');
            const dropdown = document.getElementById('menuDropdown');
            const button = document.querySelector('.menu-button');
            
            if (!menuContainer.contains(event.target)) {
                dropdown.classList.remove('show');
                button.classList.remove('active');
            }
        });

        // Toggle breakpoint markers
        function toggleBpMarkers() {
            const markers = document.getElementById('bpMarkers');
            const button = document.getElementById('bpToggle');
            
            markers.classList.toggle('show');
            button.classList.toggle('active');
        }

        // Store data loaded from CMS
        let storeData = {};
        // Function to load data from CMS
        async function loadStoreData() {
            try {
                const response = await fetch('_data/negocios.json');
                const data = await response.json();
                
                // Convert array to object with number as key
                storeData = {};
                data.negocios.forEach(negocio => {
                    storeData[negocio.numero] = {
                        name: negocio.nombre,
                        category: negocio.categoria,
                        description: negocio.descripcion,
                        instagram: negocio.instagram || null,
                        website: negocio.website || null,
                        whatsapp: negocio.whatsapp || null,
                        foto1: negocio.foto1 || null,
                        foto2: negocio.foto2 || null,
                        foto3: negocio.foto3 || null
                    };
                });
                
                // Initialize the page after loading data
                initializePage();
            } catch (error) {
                console.error('Error loading store data:', error);
                // Fallback to default empty state
                initializePage();
            }
        }

        // Category names in Spanish
        const categoryNames = {
            'alimentos': 'Alimentos',
            'ropa': 'Ropa',
            'musica': 'M√∫sica',
            'decoracion': 'Decoraci√≥n',
            'cultura': 'Cultura',
            'artesanias': 'Artesan√≠as',
            'tecnologia': 'Tecnolog√≠a',
            'belleza': 'Belleza',
            'juguetes': 'Juguetes',
            'hogar': 'Hogar',
            'servicios': 'Servicios'
        };

        // Function to open category popup
        function openCategoryPopup(categoryName, stores) {
            const popup = document.getElementById('categoryPopup');
            const popupTitle = document.getElementById('popupCategoryName');
            const popupCount = document.getElementById('popupStoreCount');
            const popupList = document.getElementById('popupStoreList');

            // Set category name and count
            popupTitle.textContent = categoryName;
            popupCount.textContent = `${stores.length} tienda${stores.length !== 1 ? 's' : ''} encontrada${stores.length !== 1 ? 's' : ''}`;

            // Clear previous content
            popupList.innerHTML = '';

            if (stores.length === 0) {
                popupList.innerHTML = '<div class="category-popup-empty">No se encontraron tiendas en esta categor√≠a</div>';
            } else {
                // Create store cards
                stores.forEach(store => {
                    const card = document.createElement('div');
                    card.className = 'category-store-card';
                    card.onclick = () => {
                        closeCategoryPopup();
                        openStoreDetailPopup(store.number);
                    };

                    let linksHTML = '';
                    if (store.instagram) {
                        linksHTML += `<a href="${store.instagram}" target="_blank" class="category-store-link" onclick="event.stopPropagation()">üì∑ Instagram</a>`;
                    }
                    if (store.website) {
                        linksHTML += `<a href="${store.website}" target="_blank" class="category-store-link" onclick="event.stopPropagation()">üåê Sitio Web</a>`;
                    }
                    if (store.whatsapp) {
                        linksHTML += `<a href="https://wa.me/${store.whatsapp}" target="_blank" class="category-store-link" onclick="event.stopPropagation()">üí¨ WhatsApp</a>`;
                    }

                    card.innerHTML = `
                        <div class="category-store-header">
                            <div class="category-store-number">${store.number}</div>
                            <h3 class="category-store-name">${store.name}</h3>
                        </div>
                        <p class="category-store-description">${store.description}</p>
                        ${linksHTML ? `<div class="category-store-links">${linksHTML}</div>` : ''}
                    `;

                    popupList.appendChild(card);
                });
            }

            // Show popup
            popup.classList.add('show');
        }

        // Function to close category popup
        function closeCategoryPopup() {
            const popup = document.getElementById('categoryPopup');
            popup.classList.remove('show');
        }

        // Function to select a store on the map
        function selectStoreOnMap(storeNumber) {
            const circles = document.querySelectorAll('.map-circle');
            const targetCircle = document.querySelector(`.map-circle.circle-${storeNumber}`);

            if (targetCircle) {
                // Remove active class from all circles
                circles.forEach(c => {
                    c.classList.remove('active');
                    c.classList.remove('hover');
                });

                // Add active class to target circle
                targetCircle.classList.add('active');
                updateStoreInfo(storeNumber);

                // Scroll to map section
                document.querySelector('.map-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Store Detail Popup Variables
        let currentStoreNumber = null;
        let currentSlideIndex = 0;

        // Function to open store detail popup
        function openStoreDetailPopup(storeNumber) {
            // Use current selected store if no number provided
            if (!storeNumber) {
                storeNumber = currentStoreNumber || 1;
            }

            currentStoreNumber = storeNumber;
            const store = storeData[storeNumber];

            if (!store) return;

            // Update popup content
            document.getElementById('detailStoreNumber').textContent = storeNumber;
            document.getElementById('detailStoreName').textContent = store.name;
            document.getElementById('detailStoreDescription').textContent = store.description;

            // Update links
            const linksContainer = document.getElementById('detailStoreLinks');
            const linksSection = document.getElementById('detailLinksSection');
            linksContainer.innerHTML = '';

            let hasLinks = false;
            if (store.instagram) {
                linksContainer.innerHTML += `<a href="${store.instagram}" target="_blank" class="store-detail-link">üì∑ Instagram</a>`;
                hasLinks = true;
            }
            if (store.website) {
                const websiteUrl = store.website.startsWith('http') ? store.website : `https://${store.website}`;
                linksContainer.innerHTML += `<a href="${websiteUrl}" target="_blank" class="store-detail-link">üåê Sitio Web</a>`;
                hasLinks = true;
            }
            if (store.whatsapp) {
                const whatsappNum = store.whatsapp.replace(/\D/g, '');
                linksContainer.innerHTML += `<a href="https://wa.me/${whatsappNum}" target="_blank" class="store-detail-link">üí¨ WhatsApp</a>`;
                hasLinks = true;
            }

            // Hide links section if no links
            linksSection.style.display = hasLinks ? 'block' : 'none';

            // Update slider with photos
            const sliderContainer = document.getElementById('sliderContainer');
            sliderContainer.innerHTML = '';

            const photos = [store.foto1, store.foto2, store.foto3];
            photos.forEach((photo, index) => {
                if (photo) {
                    sliderContainer.innerHTML += `<img src="${photo}" alt="${store.name} - Foto ${index + 1}" class="slider-image" style="object-fit: cover;">`;
                } else {
                    sliderContainer.innerHTML += `<div class="slider-image">FOTO ${index + 1}</div>`;
                }
            });

            // Reset slider
            currentSlideIndex = 0;
            updateSlider();

            // Show popup
            const popup = document.getElementById('storeDetailPopup');
            popup.classList.add('show');
        }

        // Function to close store detail popup
        function closeStoreDetailPopup() {
            const popup = document.getElementById('storeDetailPopup');
            popup.classList.remove('show');
        }

        // Slider functions
        function updateSlider() {
            const container = document.getElementById('sliderContainer');
            const dots = document.querySelectorAll('.slider-dot');

            container.style.transform = `translateX(-${currentSlideIndex * 100}%)`;

            dots.forEach((dot, index) => {
                if (index === currentSlideIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        function previousSlide() {
            currentSlideIndex = (currentSlideIndex - 1 + 3) % 3;
            updateSlider();
        }

        function nextSlide() {
            currentSlideIndex = (currentSlideIndex + 1) % 3;
            updateSlider();
        }

        function goToSlide(index) {
            currentSlideIndex = index;
            updateSlider();
        }

        // Close popup when clicking on overlay
        document.addEventListener('DOMContentLoaded', function() {
            const categoryPopup = document.getElementById('categoryPopup');
            categoryPopup.addEventListener('click', function(e) {
                if (e.target === categoryPopup) {
                    closeCategoryPopup();
                }
            });

            const detailPopup = document.getElementById('storeDetailPopup');
            detailPopup.addEventListener('click', function(e) {
                if (e.target === detailPopup) {
                    closeStoreDetailPopup();
                }
            });

            // Close popups with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeCategoryPopup();
                    closeStoreDetailPopup();
                }
            });
        });

        // Function to update store information
        function updateStoreInfo(storeNumber) {
            const store = storeData[storeNumber];
            if (!store) return;

            // Save current store number for "Ver M√°s" button
            currentStoreNumber = storeNumber;

            // Update desktop version
            document.getElementById('storeNumberCircle').textContent = storeNumber;
            document.getElementById('storeName').textContent = store.name;
            document.getElementById('storeDescription').textContent = store.description;

            // Update mobile version
            document.getElementById('storeNumberCircleMobile').textContent = storeNumber;
            document.getElementById('storeNameMobile').textContent = store.name;
            document.getElementById('storeDescriptionMobile').textContent = store.description;

            // Show "Ver M√°s" button
            document.getElementById('verMasBtn').style.display = 'inline-block';
            document.getElementById('verMasBtnMobile').style.display = 'block';
        }

        // Function to toggle category filter dropdown
        function toggleCategoryFilter() {
            const dropdown = document.getElementById('categoryFilterDropdown');
            const dropdownMobile = document.getElementById('categoryFilterDropdownMobile');
            const button = document.getElementById('categoryFilterBtn');
            const buttonMobile = document.getElementById('categoryFilterBtnMobile');
            
            // Toggle desktop dropdown
            if (dropdown) {
                dropdown.classList.toggle('show');
                if (button) {
                    button.classList.toggle('active');
                }
            }
            
            // Toggle mobile dropdown
            if (dropdownMobile) {
                dropdownMobile.classList.toggle('show');
                if (buttonMobile) {
                    buttonMobile.classList.toggle('active');
                }
            }
        }

        // Function to filter by category (desktop)
        function filterByCategory() {
            const selectedCategory = document.getElementById('categorySelect').value;
            performCategoryFilter(selectedCategory);
            
            // Hide dropdown after selection
            hideCategoryDropdown();
        }

        // Function to filter by category (mobile)
        function filterByCategoryMobile() {
            const selectedCategory = document.getElementById('categorySelectMobile').value;
            performCategoryFilter(selectedCategory);
            
            // Sync both selects
            document.getElementById('categorySelect').value = selectedCategory;
            
            // Hide dropdown after selection
            hideCategoryDropdown();
        }

        // Function to hide category dropdown
        function hideCategoryDropdown() {
            const dropdown = document.getElementById('categoryFilterDropdown');
            const dropdownMobile = document.getElementById('categoryFilterDropdownMobile');
            const button = document.getElementById('categoryFilterBtn');
            const buttonMobile = document.getElementById('categoryFilterBtnMobile');
            
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            if (dropdownMobile) {
                dropdownMobile.classList.remove('show');
            }
            if (button) {
                button.classList.remove('active');
            }
            if (buttonMobile) {
                buttonMobile.classList.remove('active');
            }
        }

        // Function to perform category filtering
        function performCategoryFilter(selectedCategory) {
            const circles = document.querySelectorAll('.map-circle');

            // Remove all category highlights first
            circles.forEach(circle => {
                circle.classList.remove('category-highlight');
            });

            if (selectedCategory === '') {
                // Show all stores normally
                updateStoreInfo(1);
                document.getElementById('storeNumberCircle').textContent = '1';
                document.getElementById('storeName').textContent = 'MERCADO CONDELL';
                document.getElementById('storeDescription').textContent = 'Selecciona un n√∫mero en el mapa para ver la informaci√≥n de la tienda.';

                // Mobile version
                document.getElementById('storeNumberCircleMobile').textContent = '1';
                document.getElementById('storeNameMobile').textContent = 'MERCADO CONDELL';
                document.getElementById('storeDescriptionMobile').textContent = 'Selecciona un n√∫mero en el mapa para ver la informaci√≥n de la tienda.';
                return;
            }

            // Find stores that match the category
            const matchingStores = [];

            for (let storeNumber in storeData) {
                const store = storeData[storeNumber];
                if (store.category === selectedCategory) {
                    matchingStores.push({
                        number: storeNumber,
                        name: store.name,
                        description: store.description,
                        instagram: store.instagram,
                        website: store.website,
                        whatsapp: store.whatsapp
                    });

                    // Highlight matching circles
                    const circle = document.querySelector(`.map-circle.circle-${storeNumber}`);
                    if (circle) {
                        circle.classList.add('category-highlight');
                    }
                }
            }

            // Sort stores by number
            matchingStores.sort((a, b) => parseInt(a.number) - parseInt(b.number));

            // Get category display name
            const categoryDisplayName = categoryNames[selectedCategory] || selectedCategory;

            // Open popup with filtered stores
            openCategoryPopup(categoryDisplayName, matchingStores);
        }

        // Initialize page after data is loaded
        function initializePage() {
            const circles = document.querySelectorAll('.map-circle');
            let isTouchDevice = false;
            let selectedStore = 1; // Track the currently selected store

            // Update all tooltips with real store names from CMS
            for (let i = 1; i <= 20; i++) {
                const tooltip = document.getElementById(`tooltip-${i}`);
                if (tooltip && storeData[i]) {
                    tooltip.textContent = storeData[i].name;
                }
            }

            // Detect if it's a touch device
            window.addEventListener('touchstart', function() {
                isTouchDevice = true;
            }, { once: true });

            // Function to position tooltips based on circle location
            function positionTooltip(circle) {
                const tooltip = circle.querySelector('.tooltip');
                if (!tooltip) return;

                const mapSection = document.querySelector('.map-section');
                const circleRect = circle.getBoundingClientRect();
                const mapRect = mapSection.getBoundingClientRect();

                // Calculate circle position relative to map
                const circleLeft = circleRect.left - mapRect.left;
                const circleRight = mapRect.right - circleRect.right;

                // Remove previous positioning classes
                tooltip.classList.remove('tooltip-left', 'tooltip-right');

                // If circle is on the left edge (less than 20% from left)
                if (circleLeft < mapRect.width * 0.2) {
                    tooltip.classList.add('tooltip-right');
                }
                // If circle is on the right edge (less than 20% from right)
                else if (circleRight < mapRect.width * 0.2) {
                    tooltip.classList.add('tooltip-left');
                }
                // Otherwise, keep default top-center position
            }

            circles.forEach(circle => {
                const storeNumber = parseInt(circle.textContent);

                // Position tooltip on page load
                positionTooltip(circle);
                
                // Mouse events for desktop and tablet (hover effects only)
                circle.addEventListener('mouseenter', () => {
                    if (!isTouchDevice) {
                        // Show hover info but don't change selection
                        updateStoreInfo(storeNumber);
                        circle.classList.add('hover');
                        // Reposition tooltip in case of window resize
                        positionTooltip(circle);
                    }
                });

                // Mouse leave for desktop - return to selected store
                circle.addEventListener('mouseleave', () => {
                    if (!isTouchDevice) {
                        circle.classList.remove('hover');
                        // Return to the currently selected store
                        updateStoreInfo(selectedStore);
                    }
                });
                
                // Click events for all devices - this changes the selection
                circle.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    // Update the selected store
                    selectedStore = storeNumber;

                    // Remove active class from all circles
                    circles.forEach(c => {
                        c.classList.remove('active');
                        c.classList.remove('hover');
                    });

                    // Add active class to clicked circle
                    circle.classList.add('active');
                    // Reposition tooltip before showing
                    positionTooltip(circle);
                    updateStoreInfo(storeNumber);
                });

                // Touch events for mobile devices - enhanced for better touch support
                circle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    // Mark as touch device
                    isTouchDevice = true;

                    // Update the selected store
                    selectedStore = storeNumber;

                    // Remove active class from all circles
                    circles.forEach(c => {
                        c.classList.remove('active');
                        c.classList.remove('hover');
                    });

                    // Add active class to touched circle
                    circle.classList.add('active');
                    // Reposition tooltip before showing
                    positionTooltip(circle);
                    updateStoreInfo(storeNumber);
                });
                
                // Touch end event to prevent conflicts
                circle.addEventListener('touchend', (e) => {
                    e.preventDefault();
                });
            });

            // Initialize with store 1 and mark it as active
            selectedStore = 1;
            updateStoreInfo(1);
            document.querySelector('.map-circle.circle-1').classList.add('active');

            // Reposition tooltips on window resize
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    circles.forEach(circle => positionTooltip(circle));
                }, 200);
            });

            // Close category dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const categoryContainer = document.querySelectorAll('.category-filter-container');
                let isInsideCategory = false;
                
                categoryContainer.forEach(container => {
                    if (container.contains(event.target)) {
                        isInsideCategory = true;
                    }
                });
                
                if (!isInsideCategory) {
                    hideCategoryDropdown();
                }
            });
        }

        // Load data when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            loadStoreData();
        });
    </script>
    
    <script>
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => {
                        document.location.href = "/admin/";
                    });
                }
            });
        }
    </script>
</body>
</html>